<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Logroño · Delay por H3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html,body,#map{height:100%;margin:0}
    .legend{background:#fff;padding:8px 10px;border:1px solid #ddd;border-radius:6px;font:12px/1.2 system-ui;position:absolute;bottom:12px;left:12px}
    .legend .row{display:flex;align-items:center;margin:2px 0}
    .swatch{width:14px;height:14px;border-radius:3px;margin-right:6px;border:1px solid #0001}
  </style>
</head>
<body>
<div id="map"></div>
<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const map = L.map('map').setView([42.4627, -2.44498], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19, attribution:'© OpenStreetMap'
}).addTo(map);

async function loadGeoJSON(){
  const res = await fetch('/map/hex', {cache:'no-cache'});
  if(!res.ok) return;
  const gj = await res.json();

  const layer = L.geoJSON(gj, {
    style: f => f.properties?.style || {color:'#333', weight:1, fillOpacity:0.6},
    onEachFeature: (f, l) => {
      const p = f.properties || {};
      l.bindPopup(`
        <b>${p.h3 ?? ''}</b><br/>
        delay_final: <b>${Number(p.delay_final).toFixed(2)}</b><br/>
        delay_orange: ${Number(p.delay_orange).toFixed(2)}<br/>
        delay_tomtom: ${Number(p.delay_tomtom).toFixed(2)}<br/>
        vol_norm: ${Number(p.vol_norm).toFixed(2)}<br/>
        truck_share: ${Number(p.truck_share).toFixed(2)}<br/>
        conf: ${Number(p.conf).toFixed(2)}
      `);
    }
  }).addTo(map);

  map.fitBounds(layer.getBounds(), {padding:[20,20]});
  buildLegend();
}

function buildLegend(){
  const stops = [
    {c:'#e9f7ef',v:'1.00+'},
    {c:'#d4f2e3',v:''},
    {c:'#bfeacc',v:''},
    {c:'#a9e3b6',v:''},
    {c:'#fff3b0',v:''},
    {c:'#ffe08a',v:''},
    {c:'#ffc266',v:''},
    {c:'#ff9f58',v:''},
    {c:'#ff7a55',v:''},
    {c:'#f5544f',v:''},
    {c:'#d73a49',v:`${(1+ (6-1)).toFixed(2)}`}, // tope (delay_max)
  ];
  const el = document.getElementById('legend');
  el.innerHTML = '<b>Delay factor</b>';
  stops.forEach(s=>{
    const row = document.createElement('div'); row.className='row';
    const sw = document.createElement('span'); sw.className='swatch'; sw.style.background=s.c;
    const tx = document.createElement('span'); tx.textContent = s.v;
    row.appendChild(sw); row.appendChild(tx); el.appendChild(row);
  });
}

loadGeoJSON();
</script>
</body>
</html>
