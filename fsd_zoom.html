<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Demo Flow Segment Data — comparación por zoom (Logroño)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af;
  --brand:#22d3ee; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  --violet:#a78bfa; --pink:#ec4899; --amber:#f59e0b; --cyan:#22d3ee;
}
*{box-sizing:border-box}
body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text)}
.container{display:grid; grid-template-columns: 360px 1fr; gap:0; height:100vh}
.sidebar{background:var(--panel); padding:14px 14px 8px; border-right:1px solid rgba(255,255,255,.08); overflow:auto}
h1{font-size:18px; margin:0 0 8px}
small{color:var(--sub)}
.label{font-size:12px; color:var(--sub); margin:8px 0 4px}
input, select, button{
  width:100%; padding:9px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15);
  background:var(--muted); color:var(--text); outline:none; font-size:14px;
}
.row{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
.btn{background:linear-gradient(90deg, var(--brand), var(--violet)); border:none; cursor:pointer; font-weight:700}
.btn.secondary{background:transparent; border:1px solid rgba(255,255,255,.2)}
.kpi{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px; margin-top:8px}
.kpi .v{font-weight:700}
.note{font-size:12px; color:var(--sub); margin-top:6px}
#map{height:100%; width:100%}
.legend{font-size:12px; color:#111; background:#fff; padding:6px 8px; border-radius:6px; border:1px solid #ddd}
code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:6px}
.err{color:#fecaca}
.success{color:#d1fae5}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h1>Flow Segment Data — Zoom demo</h1>
    <small>Haz clic en el mapa para elegir un punto en Logroño. Introduce tu API key, elige zoom y pulsa “Consultar”.</small>

    <label class="label">API Key (TomTom)</label>
    <input id="apiKey" type="text" placeholder="TU_API_KEY" autocomplete="off"/>

    <div class="row">
      <div>
        <label class="label">Style</label>
        <select id="style">
          <option value="absolute" selected>absolute</option>
          <option value="relative">relative</option>
          <option value="relative0">relative0</option>
          <option value="relative0-dark">relative0-dark</option>
          <option value="relative-delay">relative-delay</option>
          <option value="reduced-sensitivity">reduced-sensitivity</option>
        </select>
      </div>
      <div>
        <label class="label">Zoom FSD</label>
        <select id="zoomSel">
          <option>10</option>
          <option selected>12</option>
          <option>14</option>
          <option>16</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label class="label">Unidad</label>
        <select id="unit">
          <option>kmph</option>
          <option>mph</option>
        </select>
      </div>
      <div>
        <label class="label">OpenLR</label>
        <select id="openlr">
          <option>true</option>
          <option selected>false</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnFetch">Consultar</button>
      <button class="btn secondary" id="btnCompare">Comparar 10/12/14</button>
    </div>

    <div class="kpi">
      <div><b>Punto:</b> <span id="pt">42.46272, -2.44499</span></div>
      <div class="note">Clic en el mapa para cambiar.</div>
    </div>

    <div class="kpi">
      <div><b>Resultado:</b> <span id="status">—</span></div>
      <div id="metrics" class="note"></div>
    </div>

    <div class="kpi">
      <b>Estructura (resumen)</b>
      <pre style="white-space:pre-wrap; font-size:12px; margin:6px 0 0">
flowSegmentData {
  frc, currentSpeed, freeFlowSpeed,
  currentTravelTime, freeFlowTravelTime,
  confidence, roadClosure,
  coordinates.coordinate[]  // polilínea del tramo
  openlr (si openLr=true)
}</pre>
    </div>

    <div class="note">Si el navegador bloquea por CORS, prueba cargar el index desde un servidor local (p. ej., <code>python -m http.server</code>) o usa un proxy CORS solo para test.</div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// --- Mapa
const map = L.map('map', {zoomControl:true}).setView([42.46272,-2.44499], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

let marker = L.marker([42.46272,-2.44499], {draggable:false}).addTo(map);
let layers = []; // capas de polilíneas

map.on('click', (e)=>{
  const {lat, lng} = e.latlng;
  marker.setLatLng([lat,lng]);
  document.getElementById('pt').textContent = lat.toFixed(6)+", "+lng.toFixed(6);
});

function clearLayers(){
  layers.forEach(l => map.removeLayer(l));
  layers = [];
}

function colorForRatio(r){
  if(!isFinite(r)) return '#999';
  if(r >= 0.95) return '#22c55e'; // verde
  if(r >= 0.8) return '#f59e0b';  // ámbar
  return '#ef4444';               // rojo
}

async function fetchFSD({lat, lon, apiKey, style, zoom, unit, openLr}){
  const base = `https://api.tomtom.com/traffic/services/4/flowSegmentData/${style}/${zoom}/json`;
  const url = `${base}?point=${encodeURIComponent(lat)},${encodeURIComponent(lon)}&unit=${unit}&openLr=${openLr}&key=${encodeURIComponent(apiKey)}`;
  const res = await fetch(url, {mode:'cors'});
  if(!res.ok){
    const text = await res.text();
    throw new Error(`HTTP ${res.status}: ${text}`);
  }
  return res.json();
}

function drawSegment(data, opts){
  if(!data || !data.flowSegmentData || !data.flowSegmentData.coordinates) return null;
  const coords = data.flowSegmentData.coordinates.coordinate.map(c => [c.latitude, c.longitude]);
  const cs = data.flowSegmentData.currentSpeed;
  const ffs = data.flowSegmentData.freeFlowSpeed;
  const ratio = (cs && ffs) ? (cs/(ffs||1e-9)) : NaN;
  const color = opts.color || colorForRatio(ratio);
  const line = L.polyline(coords, {color, weight:5, opacity:0.9}).addTo(map);
  layers.push(line);
  map.fitBounds(line.getBounds(), {padding:[20,20]});

  // Métricas
  const ctt = data.flowSegmentData.currentTravelTime;
  const fftt = data.flowSegmentData.freeFlowTravelTime;
  const conf = data.flowSegmentData.confidence;
  const rc = data.flowSegmentData.roadClosure;
  const openlr = data.flowSegmentData.openlr || null;

  const mEl = document.getElementById('metrics');
  mEl.innerHTML = `<div><b>currentSpeed:</b> ${cs ?? '—'} ${opts.unit}</div>
  <div><b>freeFlowSpeed:</b> ${ffs ?? '—'} ${opts.unit}</div>
  <div><b>ratio (cs/ffs):</b> ${isFinite(ratio)?ratio.toFixed(2):'—'}</div>
  <div><b>currentTravelTime:</b> ${ctt ?? '—'} s</div>
  <div><b>freeFlowTravelTime:</b> ${fftt ?? '—'} s</div>
  <div><b>confidence:</b> ${conf ?? '—'}</div>
  <div><b>roadClosure:</b> ${rc ?? '—'}</div>
  <div><b>openlr:</b> ${openlr ?? '—'}</div>`;
}

async function runSingle(){
  clearLayers();
  const apiKey = document.getElementById('apiKey').value.trim();
  const style = document.getElementById('style').value;
  const zoomSel = document.getElementById('zoomSel').value;
  const unit = document.getElementById('unit').value;
  const openLr = document.getElementById('openlr').value;
  const {lat, lng} = marker.getLatLng();
  const status = document.getElementById('status');
  status.innerHTML = 'Consultando…';

  try{
    const data = await fetchFSD({lat, lon:lng, apiKey, style, zoom: zoomSel, unit, openLr});
    status.innerHTML = `<span class="success">OK</span> (zoom ${zoomSel})`;
    drawSegment(data, {unit, style});
  }catch(err){
    status.innerHTML = `<span class="err">${err.message}</span>`;
  }
}

async function runCompare(){
  clearLayers();
  const apiKey = document.getElementById('apiKey').value.trim();
  const style = document.getElementById('style').value;
  const unit = document.getElementById('unit').value;
  const openLr = document.getElementById('openlr').value;
  const {lat, lng} = marker.getLatLng();
  const status = document.getElementById('status');
  status.textContent = 'Consultando zooms 10/12/14…';

  const zooms = [10,12,14];
  const colors = ['#0ea5e9','#22c55e','#f59e0b']; // azul, verde, ámbar
  try{
    for(let i=0;i<zooms.length;i++){
      const z = zooms[i];
      const data = await fetchFSD({lat, lon:lng, apiKey, style, zoom:z, unit, openLr});
      drawSegment(data, {unit, style, color: colors[i]});
    }
    status.innerHTML = '<span class="success">OK</span> (comparado 10/12/14)';
    // Add a small legend
    const legend = L.control({position:'topright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `<b>Colores por zoom</b><br>
        <span style="display:inline-block;width:10px;height:10px;background:#0ea5e9;margin-right:6px"></span> z=10<br>
        <span style="display:inline-block;width:10px;height:10px;background:#22c55e;margin-right:6px"></span> z=12<br>
        <span style="display:inline-block;width:10px;height:10px;background:#f59e0b;margin-right:6px"></span> z=14`;
      return div;
    };
    legend.addTo(map);
  }catch(err){
    status.innerHTML = `<span class="err">${err.message}</span>`;
  }
}

document.getElementById('btnFetch').addEventListener('click', runSingle);
document.getElementById('btnCompare').addEventListener('click', runCompare);
</script>
</body>
</html>